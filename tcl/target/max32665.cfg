# Maxim Integrated MAX32665 OpenOCD target configuration file
# www.maximintegrated.com

# Set the reset pin configuration
reset_config srst_only
adapter srst delay 200

# Set flash parameters
set FLASH_BASE 0x10000000
set FLASH_SIZE 0x80000
set FLC_BASE 0x40029000
set FLASH_SECTOR 0x2000
set FLASH_CLK 96
set FLASH_OPTIONS 0x01

# Use Serial Wire Debug
transport select swd

source [find target/max32xxx.cfg]

# Add additional flash bank
set FLASH_BASE 0x10080000
set FLC_BASE 0x40029400

flash bank $_CHIPNAME.flash1 max32xxx $FLASH_BASE $FLASH_SIZE 0 0 $_CHIPNAME.cpu \
$FLC_BASE $FLASH_SECTOR $FLASH_CLK $FLASH_OPTIONS

# Setup QSPI
set QSPI_ADDR_BASE 0x08000000
set QSPI_ADDR_SIZE 0x0800000
set OPTIONS 0x0

flash bank $_CHIPNAME.qspi_flash max32xxx_qspi $QSPI_ADDR_BASE $QSPI_ADDR_SIZE \
0 0 $_CHIPNAME.cpu $OPTIONS

proc init_spi {} {
  # Enable SPI and GPIO0 clocks
  mww 0x40000024 0x3FFFFFF8

  # Enable the SPI XIP cache
  mww 0x40000048 0xFFFFE7FF

  # Setup the SPI flash GPIO pins to AF1
  # Set en0, en1, and en2 registers to 0
  mww 0x40008000 0
  mww 0x40008068 0
  mww 0x40008074 0

  # Finish setting up the QSPI, 2 is the flash bank id for the qspi driver
  max32xxx_qspi reset_deassert 2
}

$_CHIPNAME.cpu configure -event halted {
  init_spi
}

$_CHIPNAME.cpu configure -event reset-deassert-post {
  init_spi
}